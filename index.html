<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpine LAMP Server â€¢ Fullscreen jsLinux</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-family: monospace; z-index: 999; text-align: center; }
        #screen { width: 100vw; height: 100vh; background: #000; display: none; }
        #screen_canvas { width: 100%; height: 100%; image-rendering: pixelated; }
    </style>
</head>
<body>
    <div id="loading">Loading Alpine LAMP Emulator... (first boot: 5-10s + auto LAMP install)</div>
    <div id="screen"><canvas id="screen_canvas" tabindex="0"></canvas></div>

    <!-- Official jsLinux script (confirmed loading: sets JSLinuxConfig + startJSLinux) -->
    <script src="https://bellard.org/jslinux/jslinux.js"></script>

    <script>
        const loadingEl = document.getElementById('loading');
        const screenEl = document.getElementById('screen');
        const canvas = document.getElementById('screen_canvas');
        const HD_KEY = 'alpine_hda';
        const HD_SIZE = 1073741824; // 1GB HD (ample for LAMP)

        // localStorage persistence for HD
        function saveHD() {
            if (window.disks && window.disks.hda) {
                try {
                    const data = window.disks.hda.export();
                    localStorage.setItem(HD_KEY, btoa(String.fromCharCode(...new Uint8Array(data))));
                    console.log('HD auto-saved to localStorage');
                } catch (e) {
                    console.error('HD save failed:', e);
                }
            }
        }

        function loadHD() {
            try {
                const saved = localStorage.getItem(HD_KEY);
                if (saved) {
                    return Uint8Array.from(atob(saved), c => c.charCodeAt(0)).buffer;
                }
            } catch (e) {
                console.error('HD load failed:', e);
            }
            return null;
        }

        // Auto-save every 30s + on close
        function startAutoSave() {
            setInterval(saveHD, 30000);
            window.addEventListener('beforeunload', saveHD);
        }

        // Helper: Send keystrokes to VM
        function sendKeys(keys) {
            if (typeof keybuf_send !== 'undefined') {
                keybuf_send(keys);
            } else {
                console.error('keybuf_send not ready');
            }
        }

        // Check if script loaded, then init
        function initJSLinux() {
            let attempts = 0;
            const maxAttempts = 10; // 5s timeout (500ms intervals)
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof startJSLinux !== 'undefined') {
                    clearInterval(checkInterval);
                    console.log('jsLinux script loaded successfully');
                    setupAndStart();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    loadingEl.innerHTML = 'Error: jsLinux script failed to load after 5s. Refresh and check console (F12).';
                    console.error('startJSLinux not defined after timeout');
                } else {
                    console.log(`Waiting for jsLinux script... (${attempts}/${maxAttempts})`);
                }
            }, 500);
        }

        function setupAndStart() {
            const savedHD = loadHD();
            const hasHD = savedHD !== null;

            // Official embedding: Set JSLinuxConfig global
            window.JSLinuxConfig = {
                // Boot Alpine Linux (lightweight, Arch-like with apk)
                url: 'https://bellard.org/jslinux/alpine-x86.cfg',
                // Fullscreen VGA canvas
                vga: 'canvas',
                vga_id: 'screen_canvas',
                // HD persistence
                disks: ['hda'],
                hda: hasHD ? { import: savedHD } : { size: HD_SIZE },
                // Networking for LAMP installs
                net: true,
                // Memory (MB)
                memory: 256,
                // Auto-start
                autostart: true
            };

            startJSLinux();
            console.log('jsLinux started with config:', window.JSLinuxConfig);

            // Post-boot hooks: Poll for disks ready
            const checkReady = setInterval(() => {
                if (window.disks && window.disks.hda) {
                    clearInterval(checkReady);
                    loadingEl.style.display = 'none';
                    screenEl.style.display = 'block';
                    canvas.focus();
                    startAutoSave();
                    console.log('jsLinux ready! Boots Alpine root (no pass). LAMP auto-install if new.');

                    // Auto-LAMP on first boot (staggered keystrokes)
                    if (!hasHD) {
                        setTimeout(() => {
                            sendKeys('apk update\n');
                        }, 3000);
                        setTimeout(() => {
                            sendKeys('apk add apache2 php81 php81-apache2 mariadb mariadb-client\n');
                        }, 5000);
                        setTimeout(() => {
                            sendKeys('rc-service apache2 start && rc-service mariadb start\n');
                        }, 15000);
                        setTimeout(() => {
                            sendKeys('echo "<?php phpinfo(); ?>" > /var/www/localhost/htdocs/index.php\n');
                        }, 20000);
                        setTimeout(() => {
                            sendKeys('mariadb -u root -e "CREATE DATABASE testdb;"\n');
                        }, 25000);
                        console.log('LAMP auto-install commands sent! Monitor console for progress.');
                    }
                }
            }, 1000);
        }

        // Boot after DOM + script load
        window.addEventListener('load', () => {
            setTimeout(initJSLinux, 100); // Small delay for script parse
        });
    </script>
</body>
</html>
