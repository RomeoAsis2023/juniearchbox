<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux LAMP Server â€¢ Fullscreen v86</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-family: Arial; z-index: 999; text-align: center; }
        #screen_container { 
            width: 100vw; 
            height: 100vh; 
            position: absolute; 
            top: 0; 
            left: 0;
            opacity: 0; 
            transition: opacity 0.5s ease-in; 
        }
        #screen_canvas { 
            width: 100%; 
            height: 100%; 
            image-rendering: pixelated; 
            display: block;
            background: #000; 
        }
    </style>
</head>
<body>
    <div id="loading">Loading Linux LAMP Emulator... (first boot: 10-30s + auto LAMP install)</div>
    <div id="screen_container">
        <canvas id="screen_canvas"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/v86@latest/build/libv86.js"></script>

    <script>
        let emulator = null;
        const DB_NAME = 'linux_v86_persistence';
        const HD_KEY = 'linux_hda';
        const STATE_KEY = 'linux_fullstate';
        const HD_SIZE = 10 * 1024 * 1024 * 1024; // 10 GB
        let db = null;

        // IndexedDB helpers
        const openDB = () => new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = (e) => {
                const store = e.target.result.createObjectStore('store');
            };
            req.onsuccess = (e) => {
                db = e.target.result;
                resolve();
            };
            req.onerror = reject;
        });

        const getItem = (key) => new Promise((resolve) => {
            if (!db) return resolve(null);
            const tx = db.transaction('store', 'readonly');
            const req = tx.objectStore('store').get(key);
            req.onsuccess = () => resolve(req.result || null);
        });

        const putItem = (key, value) => new Promise((resolve) => {
            if (!db) return resolve(false);
            const tx = db.transaction('store', 'readwrite');
            const req = tx.objectStore('store').put(value, key);
            req.onsuccess = () => resolve(true);
            req.onerror = () => resolve(false);
        });

        // Save HD image
        async function saveHD() {
            if (!emulator || !emulator.bus?.devices?.hda) return;
            try {
                const data = emulator.bus.devices.hda.data;
                const buffer = data.buffer.slice(0, data.byteLength);
                await putItem(HD_KEY, buffer);
                console.log('HD auto-saved to IndexedDB');
            } catch (e) {
                console.error('HD save failed:', e);
            }
        }

        // Save full emulator state
        async function saveFullState() {
            if (!emulator) return;
            try {
                const state = await emulator.create_snapshot();
                await putItem(STATE_KEY, state);
                console.log('Full state auto-saved');
            } catch (e) {
                console.error('State save failed:', e);
            }
        }

        // Start auto-save loop
        function startAutoSave() {
            setInterval(async () => {
                await saveHD();
                await saveFullState();
            }, 30000); // 30 seconds
        }

        // Boot the emulator
        async function boot() {
            try {
                await openDB();
                const savedHD = await getItem(HD_KEY);
                const savedState = await getItem(STATE_KEY);

                const config = {
                    screen_container: document.getElementById("screen_canvas"),
                    // Official v86 BIOS
                    bios: { url: "https://cdn.jsdelivr.net/gh/copy/v86@master/bios/seabios.bin" },
                    vga_bios: { url: "https://cdn.jsdelivr.net/gh/copy/v86@master/bios/vgabios.bin" },
                    // Your requested ISO: Official lightweight Linux live CD
                    cdrom: { 
                        url: "https://raw.githubusercontent.com/copy/images/master/linux.iso" 
                    },
                    // Enable networking for package installs
                    virtio: true,
                    memory_size: 2 * 1024 * 1024 * 1024, // 2 GB RAM
                    vga_memory_size: 16 * 1024 * 1024, // 16 MB VRAM
                    autostart: true
                };

                if (savedHD && savedHD.byteLength > 0) {
                    config.hda = { buffer: savedHD };
                    console.log('Loaded saved HD image (LAMP ready?)');
                    if (savedState && savedState.byteLength > 0) {
                        config.state = { buffer: savedState };
                        console.log('Loaded saved emulator state');
                    }
                } else {
                    config.hda = { size: HD_SIZE };
                    console.log('Created new empty 10GB HD');
                }

                emulator = new V86(config);

                emulator.add_listener("emulator-ready", () => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('screen_container').style.opacity = '1';
                    startAutoSave();
                    console.log('Emulator ready! Boots to root shell (no pass). Auto-LAMP script runs on first boot.');
                });

                emulator.add_listener("emulator-stopped", () => {
                    console.log('Emulator stopped unexpectedly');
                });
            } catch (e) {
                console.error('Boot error:', e);
                document.getElementById('loading').innerHTML = `Error: ${e.message}. Refresh and try again.`;
            }
        }

        // Save on page close/refresh
        window.addEventListener("beforeunload", async () => {
            if (emulator) {
                await saveHD();
                await saveFullState();
            }
        });

        // Ensure DOM ready, then auto-boot
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', boot);
        } else {
            boot();
        }
    </script>
</body>
</html>
