<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arch Linux â€¢ Fullscreen</title>
    <style>
        body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
        #screen_container { width:100vw; height:100vh; }
        canvas { image-rendering: pixelated; } /* optional: sharper pixels */
    </style>
</head>
<body>
    <div id="screen_container"></div>

    <script src="https://copy.sh/v86/libv86.js"></script>
    <script>
        let emulator = null;
        const DB_NAME = 'arch_v86_persistence';
        const HD_KEY = 'arch_hda';
        const STATE_KEY = 'arch_fullstate';
        const HD_SIZE = 10 * 1024 * 1024 * 1024; // 10 GB
        let db = null;

        // Simple IndexedDB wrapper
        const openDB = () => new Promise(r => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore('store');
            req.onsuccess = e => { db = e.target.result; r(); };
        });

        const get = key => new Promise(r => {
            if (!db) return r(null);
            const tx = db.transaction('store'); 
            const req = tx.objectStore('store').get(key);
            req.onsuccess = () => r(req.result || null);
        });

        const put = (key, value) => new Promise(r => {
            if (!db) return r(false);
            const tx = db.transaction('store', 'readwrite');
            tx.objectStore('store').put(value, key);
            tx.oncomplete = () => r(true);
        });

        // Save hard disk
        async function saveHD() {
            if (!emulator || !emulator.bus?.devices?.hda) return;
            const buffer = emulator.bus.devices.hda.data.buffer.slice(0);
            await put(HD_KEY, buffer);
        }

        // Save full state (RAM + CPU + everything)
        async function saveFullState() {
            if (!emulator) return;
            try {
                const state = await emulator.save_state();
                await put(STATE_KEY, state);
            } catch(e) { console.log("State save skipped:", e); }
        }

        // Auto-save loop
        function startAutoSave() {
            setInterval(async () => {
                await saveHD();
                await saveFullState();
            }, 30_000); // every 30 seconds
        }

        // Load everything and start
        async function boot() {
            await openDB();

            const savedHD = await get(HD_KEY);
            const savedState = await get(STATE_KEY);

            const config = {
                screen_container: document.getElementById("screen_container"),
                bios: { url: "https://copy.sh/v86/images/seabios.bin" },
                vga_bios: { url: "https://copy.sh/v86/images/vgabios.bin" },
                cdrom: { url: "https://copy.sh/v86/images/archlinux.iso" },
                memory_size: 1024 * 1024 * 1024,    // 1 GB RAM (feel free to bump to 2G)
                vga_memory_size: 16 * 1024 * 1024,
                autostart: true,
                disable_mouse: false,
                disable_keyboard: false,
            };

            if (savedHD) {
                config.hda = { buffer: savedHD };
                if (savedState) {
                    config.initial_state = { buffer: savedState };
                }
            } else {
                config.hda = { size: HD_SIZE }; // first-time empty disk
            }

            emulator = new V86Starter(config);

            // Start auto-saving once emulator is ready
            emulator.add_listener("emulator-ready", () => {
                startAutoSave();
            });
        }

        // Save on page hide/unload (Ctrl+W, refresh, close tab, etc.)
        window.addEventListener("beforeunload", async () => {
            await saveHD();
            await saveFullState();
        });

        // GO!
        boot();
    </script>
</body>
</html>
