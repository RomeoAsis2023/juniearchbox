<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arch Linux • Fullscreen</title>
    <style>
        body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000}
        #screen_container{width:100vw;height:100vh;display:none}
        #loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-family:Arial;z-index:999}
        canvas{image-rendering:pixelated;width:100%;height:100%}
    </style>
</head>
<body>
    <div id="loading">Loading Arch Linux… (first boot ≈ 60–90 seconds)</div>
    <div id="screen_container"></div>

    <!-- This is the ONLY correct URL that exports the V86 class in 2025 -->
    <script src="https://cdn.jsdelivr.net/gh/copy/v86@master/build/libv86.js"></script>

    <script>
        let emulator = null;
        const DB = 'archbox_persistence';
        const HD_KEY = 'hda';
        const STATE_KEY = 'state';
        const HD_SIZE = 10 * 1024*1024*1024; // 10 GB
        let db = null;

        const openDB = () => new Promise(res => {
            const r = indexedDB.open(DB, 1);
            r.onupgradeneeded = () => r.result.createObjectStore('k');
            r.onsuccess = () => { db = r.result; res(); };
        });

        const get = k => new Promise(res => {
            if (!db) return res(null);
            const t = db.transaction('k'); 
            const q = t.objectStore('k').get(k);
            q.onsuccess = () => res(q.result || null);
        });

        const put = (k, v) => new Promise(res => {
            if (!db) return res(false);
            const t = db.transaction('k', 'readwrite');
            t.objectStore('k').put(v, k).onsuccess = () => res(true);
        });

        async function saveHD() {
            if (!emulator?.v86?.hda) return;
            const buf = emulator.v86.hda.buffer.slice(0);
            await put(HD_KEY, buf);
            console.log('HD saved');
        }

        async function saveState() {
            if (!emulator) return;
            try {
                const state = await emulator.save_state();
                await put(STATE_KEY, state);
                console.log('Full state saved');
            } catch(e) { console.log('state save skipped', e); }
        }

        async function boot() {
            await openDB();

            const savedHD = await get(HD_KEY);
            const savedState = await get(STATE_KEY);

            const cfg = {
                screen_container: document.getElementById('screen_container'),
                bios: { url: "https://cdn.jsdelivr.net/gh/copy/v86@master/bios/seabios.bin" },
                vga_bios: { url: "https://cdn.jsdelivr.net/gh/copy/v86@master/bios/vgabios.bin" },
                cdrom: { url: "https://copy.sh/v86/images/archlinux.iso" },
                memory_size: 2 * 1024*1024*1024,     // 2 GB RAM
                vga_memory_size: 16*1024*1024,
                autostart: true,
            };

            if (savedHD) {
                cfg.hda = { buffer: savedHD };
                if (savedState) cfg.state = savedState;
            } else {
                cfg.hda = { size: HD_SIZE };
            }

            emulator = new V86(cfg);   // ← THIS IS THE CORRECT CLASS

            emulator.add_listener("emulator-ready", () => {
                document.getElementById('loading').remove();
                document.getElementById('screen_container').style.display = 'block';
                setInterval(() => { saveHD(); saveState(); }, 30000); // every 30 s
            });
        }

        window.addEventListener("beforeunload", () => { saveHD(); saveState(); });

        boot();
    </script>
</body>
</html>
