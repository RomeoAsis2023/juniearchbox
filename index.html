<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpine LAMP Server â€¢ Fullscreen jsLinux</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-family: monospace; z-index: 999; text-align: center; }
        #screen { width: 100vw; height: 100vh; background: #000; }
        #screen_canvas { width: 100%; height: 100%; image-rendering: pixelated; }
    </style>
</head>
<body>
    <div id="loading">Loading Alpine LAMP Emulator... (first boot: 5-10s + auto LAMP install)</div>
    <div id="screen"><canvas id="screen_canvas"></canvas></div>

    <!-- Official jsLinux script (stable, no deps issues) -->
    <script src="https://bellard.org/jslinux/jslinux.js"></script>

    <script>
        const loadingEl = document.getElementById('loading');
        const canvas = document.getElementById('screen_canvas');
        let jslinux = null;
        const HD_KEY = 'alpine_hda';
        const HD_SIZE = 1073741824; // 1GB HD (enough for LAMP; grow as needed)

        // Simple localStorage for persistence (base64 HD snapshots)
        function saveHD() {
            if (!jslinux || !jslinux.hda) return;
            const data = jslinux.hda.export();
            localStorage.setItem(HD_KEY, btoa(String.fromCharCode(...new Uint8Array(data))));
            console.log('HD auto-saved to localStorage');
        }

        function loadHD() {
            const saved = localStorage.getItem(HD_KEY);
            if (saved) {
                const data = Uint8Array.from(atob(saved), c => c.charCodeAt(0));
                return data.buffer;
            }
            return null;
        }

        // Auto-save every 30s + on close
        function startAutoSave() {
            setInterval(saveHD, 30000);
            window.addEventListener('beforeunload', saveHD);
        }

        // Boot jsLinux
        function boot() {
            const savedHD = loadHD();
            const config = {
                screen_container: canvas,
                // Alpine Linux (Arch-like: lightweight, apk pkg mgr)
                autoload: 'alpine-x86.cfg',
                // Enable net for LAMP installs
                net: true,
                // HD persistence
                hda: savedHD ? { buffer: savedHD } : { size: HD_SIZE },
                memory: 256, // MB RAM (bump to 512 if needed)
                autostart: true
            };

            jslinux = new JSLinux(config);

            jslinux.ready = () => {
                loadingEl.style.display = 'none';
                canvas.style.display = 'block';
                startAutoSave();
                console.log('jsLinux ready! Boots Alpine root (no pass). Auto-LAMP runs on first boot.');
                
                // Auto-install LAMP on first boot (runs via boot script)
                if (!savedHD) {
                    setTimeout(() => {
                        jslinux.keybuf_send('apk update && apk add apache2 php81 php81-apache2 mariadb mariadb-client\n');
                        jslinux.keybuf_send('rc-service apache2 start && rc-service mariadb start\n');
                        jslinux.keybuf_send('echo "<?php phpinfo(); ?>" > /var/www/localhost/htdocs/index.php\n');
                        jslinux.keybuf_send('mysql -u root -e "CREATE DATABASE testdb;"\n'); // No initial pass
                        console.log('LAMP auto-installed! Test: curl localhost');
                    }, 5000); // Delay for boot
                }
            };

            jslinux.ontrap = (trapno) => { /* Handle traps if needed */ };
        }

        // Auto-boot after DOM
        window.addEventListener('load', boot);
    </script>
</body>
</html>
